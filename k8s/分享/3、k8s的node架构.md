# **ğŸ” K8s Node èŠ‚ç‚¹æ¶æ„è¯¦è§£**

åœ¨ Kubernetesï¼ˆK8sï¼‰æ¶æ„ä¸­ï¼Œ**Nodeï¼ˆèŠ‚ç‚¹ï¼‰** è´Ÿè´£è¿è¡Œ **Pod**ï¼Œå¹¶æä¾›è®¡ç®—èµ„æºï¼ˆCPUã€å†…å­˜ã€å­˜å‚¨ç­‰ï¼‰ã€‚æ¯ä¸ª Node ä¸Šè¿è¡Œå¤šä¸ªæ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºç®¡ç† Pod çš„ç”Ÿå‘½å‘¨æœŸã€ç½‘ç»œé€šä¿¡å’Œå­˜å‚¨æŒ‚è½½ã€‚

## **ğŸ“Œ 1. Node ä¸»è¦ç»„ä»¶**

| **ç»„ä»¶**              | **ä½œç”¨**                                     |
| --------------------- | -------------------------------------------- |
| **Kubelet**           | è´Ÿè´£ Pod ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼Œä¿è¯ Pod æŒ‰ç…§å®šä¹‰è¿è¡Œ |
| **Kube Proxy**        | ç»´æŠ¤é›†ç¾¤ç½‘ç»œè§„åˆ™ï¼Œè´Ÿè´£ Pod ä¹‹é—´çš„é€šä¿¡        |
| **Container Runtime** | è´Ÿè´£ç®¡ç†å®¹å™¨çš„è¿è¡Œï¼ˆå¦‚ Dockerã€containerdï¼‰  |
| **Pod**               | Kubernetes è°ƒåº¦çš„æœ€å°å•ä½ï¼Œè¿è¡Œå…·ä½“çš„åº”ç”¨    |

# **ğŸ“Œ 2. Node è¯¦ç»†æ¶æ„**

ğŸ’¡ **Node ç»„ä»¶åœ¨ Linux æœåŠ¡å™¨ä¸Šè¿è¡Œï¼Œæ•´ä½“æ¶æ„å¦‚ä¸‹ï¼š**

```
luaå¤åˆ¶ç¼–è¾‘+----------------------------------------------------+
|                      Node                          |
|----------------------------------------------------|
|                     Pod (å¤šä¸ª)                     |
|   +--------------------------------------------+   |
|   | Container 1 + Container 2 + ...           |   |
|   +--------------------------------------------+   |
|                                                    |
|----------------------------------------------------|
| Kubelet  | Kube Proxy | Container Runtime (Docker, containerd) |
|----------------------------------------------------|
|            Linux æ“ä½œç³»ç»Ÿï¼ˆUbuntu, CentOSï¼‰         |
|----------------------------------------------------|
|            ç‰©ç†/è™šæ‹ŸæœåŠ¡å™¨ï¼ˆäº‘è®¡ç®—èµ„æºï¼‰            |
+----------------------------------------------------+
```

# **ğŸ“Œ 3. Kubeletï¼ˆæ ¸å¿ƒç»„ä»¶ï¼‰**

ğŸ’¡ **Kubelet æ˜¯ Node ä¸Šæœ€æ ¸å¿ƒçš„ç»„ä»¶ï¼Œè´Ÿè´£ Pod çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚**

## **3.1 Kubelet çš„ä½œç”¨**

- ç›‘å¬ **API Server**ï¼Œè·å–è°ƒåº¦åˆ°æœ¬èŠ‚ç‚¹çš„ Pod
- **å¯åŠ¨ã€ç›‘æ§å’Œç®¡ç† Pod**ï¼ˆé€šè¿‡ Container Runtimeï¼‰
- è´Ÿè´£ **å¥åº·æ£€æŸ¥**ï¼ˆLivenessã€Readiness æ¢é’ˆï¼‰
- è´Ÿè´£ **æ—¥å¿—æ”¶é›†ã€åº¦é‡æ•°æ®ä¸ŠæŠ¥**ï¼ˆå¦‚ Prometheus ç›‘æ§ï¼‰
- é€šè¿‡ **cAdvisor** é‡‡é›†èµ„æºä½¿ç”¨æƒ…å†µ

## **3.2 Kubelet å·¥ä½œæµç¨‹**

1ï¸âƒ£ ç›‘å¬ API Serverï¼Œè·å–è¦è¿è¡Œçš„ **Pod é…ç½®**
2ï¸âƒ£ è°ƒç”¨ **Container Runtimeï¼ˆå¦‚ Dockerï¼‰** è¿è¡Œ Pod å†…çš„å®¹å™¨
3ï¸âƒ£ æŒç»­ç›‘æ§å®¹å™¨å¥åº·çŠ¶æ€ï¼ˆå¦‚ CrashLoopBackOffï¼‰
4ï¸âƒ£ å¦‚æœ Pod å´©æºƒï¼Œ**è‡ªåŠ¨é‡å¯** å®¹å™¨
5ï¸âƒ£ é‡‡é›† Pod **æ—¥å¿—ã€ç›‘æ§æ•°æ®**ï¼Œä¸ŠæŠ¥ç»™ API Server

## **3.3 å…³é”®å‘½ä»¤**

```
shå¤åˆ¶ç¼–è¾‘# æŸ¥çœ‹ Kubelet è¿è¡ŒçŠ¶æ€
systemctl status kubelet

# æŸ¥çœ‹å½“å‰ Node çš„ Pod
kubectl get pods -o wide
```

# **ğŸ“Œ 4. Kube Proxyï¼ˆç½‘ç»œé€šä¿¡æ ¸å¿ƒï¼‰**

ğŸ’¡ **Kube Proxy è´Ÿè´£ Kubernetes é›†ç¾¤çš„ç½‘ç»œç®¡ç†ï¼Œç¡®ä¿ Pod ä¹‹é—´å¯ä»¥äº’ç›¸é€šä¿¡ã€‚**

## **4.1 ä½œç”¨**

- **ç»´æŠ¤ Service è®¿é—®è§„åˆ™**ï¼ˆiptablesã€IPVSï¼‰
- **ç®¡ç† Pod ä¹‹é—´çš„ç½‘ç»œè¿æ¥**
- **æ”¯æŒè´Ÿè½½å‡è¡¡**ï¼Œä¿è¯æµé‡åˆ†å‘åˆ°å¤šä¸ª Pod

## **4.2 å·¥ä½œæ–¹å¼**

1ï¸âƒ£ **ç›‘å¬ API Server**ï¼Œè·å– Service å’Œ Endpoint ä¿¡æ¯
2ï¸âƒ£ ç»´æŠ¤ **iptables æˆ– IPVS è§„åˆ™**ï¼Œç¡®ä¿ Pod é—´é€šä¿¡
3ï¸âƒ£ å®ç° **ClusterIPã€NodePortã€LoadBalancer** ç±»å‹çš„ Service
4ï¸âƒ£ è´Ÿè´£ **Pod ä¹‹é—´çš„ DNS è§£æ**ï¼ˆå¦‚ `my-service.default.svc.cluster.local`ï¼‰

## **4.3 å…³é”®å‘½ä»¤**

```
shå¤åˆ¶ç¼–è¾‘# æŸ¥çœ‹ kube-proxy çŠ¶æ€
systemctl status kube-proxy

# æŸ¥çœ‹ Service è§„åˆ™ï¼ˆiptablesï¼‰
iptables -t nat -L -n -v
```

------

# **ğŸ“Œ 5. Container Runtimeï¼ˆå®¹å™¨è¿è¡Œæ—¶ï¼‰**

ğŸ’¡ **Kubernetes ä½¿ç”¨ Container Runtime æ¥è¿è¡Œå’Œç®¡ç†å®¹å™¨ã€‚**

## **5.1 æ”¯æŒçš„å®¹å™¨è¿è¡Œæ—¶**

- **Docker**ï¼ˆæœ€å¸¸ç”¨ï¼‰
- **containerd**ï¼ˆè½»é‡çº§ï¼Œæ€§èƒ½æ›´ä¼˜ï¼‰
- **CRI-O**ï¼ˆä¸“ä¸º K8s è®¾è®¡çš„å®¹å™¨è¿è¡Œæ—¶ï¼‰

## **5.2 å·¥ä½œæ–¹å¼**

1ï¸âƒ£ Kubelet é€šè¿‡ **CRIï¼ˆContainer Runtime Interfaceï¼‰** è°ƒç”¨å®¹å™¨è¿è¡Œæ—¶
2ï¸âƒ£ å®¹å™¨è¿è¡Œæ—¶æ‹‰å– **é•œåƒ**ï¼Œåˆ›å»ºå¹¶è¿è¡Œå®¹å™¨
3ï¸âƒ£ ç®¡ç†å®¹å™¨çš„ **ç”Ÿå‘½å‘¨æœŸ**ï¼Œæä¾›æ—¥å¿—ã€ç›‘æ§ç­‰

## **5.3 å…³é”®å‘½ä»¤**

```
shå¤åˆ¶ç¼–è¾‘# æŸ¥çœ‹å½“å‰è¿è¡Œçš„å®¹å™¨
docker ps

# è¿›å…¥å®¹å™¨å†…éƒ¨
docker exec -it <container_id> sh
```

------

# **ğŸ“Œ 6. Podï¼ˆKubernetes è¿è¡Œå•å…ƒï¼‰**

ğŸ’¡ **Pod æ˜¯ Kubernetes çš„æœ€å°è°ƒåº¦å•å…ƒï¼ŒåŒ…å«ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨ã€‚**

## **6.1 ç»„æˆ**

- **ä¸€ä¸ªæˆ–å¤šä¸ªå®¹å™¨**
- **å…±äº«ç½‘ç»œï¼ˆåŒä¸€ IP åœ°å€ï¼‰**
- **å…±äº«å­˜å‚¨å·ï¼ˆVolumeï¼‰**

## **6.2 Pod é€šä¿¡**

- Pod ä¹‹é—´é€šè¿‡ **Pod IP** ç›´æ¥é€šä¿¡
- Pod è®¿é—® Serviceï¼Œé€šè¿‡ **ClusterIP** æˆ– **NodePort**

## **6.3 å…³é”®å‘½ä»¤**

```
shå¤åˆ¶ç¼–è¾‘# æŸ¥çœ‹æ‰€æœ‰ Pod
kubectl get pods -o wide

# è¿›å…¥ Pod å†…éƒ¨
kubectl exec -it <pod_name> -- sh
```

------

# **ğŸ“Œ 7. Node é«˜å¯ç”¨**

## **7.1 Node å¤±æ•ˆæ£€æµ‹**

ğŸ’¡ **K8s é€šè¿‡ Node Controller ç›‘æµ‹ Node çŠ¶æ€ï¼Œé»˜è®¤ 5 åˆ†é’Ÿæ— å“åº”å°±åˆ¤å®šä¸º "NotReady"ã€‚**

- **å¿ƒè·³æ£€æµ‹**ï¼šKubelet æ¯ 10 ç§’å‘é€å¿ƒè·³åˆ° API Server
- Node å¤±æ•ˆç­–ç•¥
  - **5 åˆ†é’Ÿå†…æ— å¿ƒè·³**ï¼šæ ‡è®°ä¸º `NotReady`
  - **Pod ä»ç„¶è¿è¡Œ**ï¼šä¸ä¼šç«‹åˆ»åˆ é™¤ Pod
  - **è¶…è¿‡ 5 åˆ†é’Ÿ**ï¼šé©±é€ï¼ˆEvictionï¼‰Podï¼Œé‡æ–°è°ƒåº¦åˆ°å…¶ä»– Node

```
shå¤åˆ¶ç¼–è¾‘# æŸ¥çœ‹ Node çŠ¶æ€
kubectl get nodes
```

------

# **ğŸ“Œ 8. Node èµ„æºé™åˆ¶**

ğŸ’¡ **K8s å…è®¸å¯¹ Node èµ„æºè¿›è¡Œé™åˆ¶ï¼Œä»¥é˜²æ­¢èµ„æºè€—å°½ã€‚**

## **8.1 èµ„æºé…é¢**

- **CPU é™åˆ¶**ï¼ˆä½¿ç”¨ `millicores`ï¼‰
- **å†…å­˜é™åˆ¶**ï¼ˆMiã€Giï¼‰
- **å­˜å‚¨é™åˆ¶**ï¼ˆPVã€PVCï¼‰

```
yamlå¤åˆ¶ç¼–è¾‘apiVersion: v1
kind: LimitRange
metadata:
  name: resource-limits
spec:
  limits:
  - type: Container
    max:
      cpu: "2"
      memory: "2Gi"
    min:
      cpu: "100m"
      memory: "128Mi"
```

------

# **ğŸ“Œ 9. Node å…³é”®å‘½ä»¤**

```
shå¤åˆ¶ç¼–è¾‘# æŸ¥çœ‹ Node ä¿¡æ¯
kubectl get nodes -o wide

# æŸ¥çœ‹ Node è¯¦ç»†ä¿¡æ¯
kubectl describe node <node_name>

# æŸ¥çœ‹ Pod åœ¨ Node ä¸Šçš„åˆ†å¸ƒæƒ…å†µ
kubectl get pods -o wide

# æ ‡è®° Node ä¸ºä¸å¯è°ƒåº¦
kubectl cordon <node_name>

# æ¢å¤ Node è°ƒåº¦èƒ½åŠ›
kubectl uncordon <node_name>

# é©±é€æ‰€æœ‰ Podï¼ˆNode ç»´æŠ¤ï¼‰
kubectl drain <node_name> --ignore-daemonsets --delete-emptydir-data
```

------

# **ğŸ“Œ 10. æ€»ç»“**

| **ç»„ä»¶**              | **ä½œç”¨**                        |
| --------------------- | ------------------------------- |
| **Kubelet**           | è´Ÿè´£ Pod è¿è¡Œï¼Œç›‘æ§å®¹å™¨çŠ¶æ€     |
| **Kube Proxy**        | è´Ÿè´£ç½‘ç»œç®¡ç†ï¼Œç»´æŒ Service è§„åˆ™ |
| **Container Runtime** | è¿è¡Œå®¹å™¨ï¼ˆDocker, containerdï¼‰  |
| **Pod**               | Kubernetes è¿è¡Œçš„æœ€å°å•å…ƒ       |

ğŸš€ **Node ä½œä¸º Kubernetes è®¡ç®—èµ„æºçš„æ ¸å¿ƒï¼Œæ‰¿æ‹…äº†å®¹å™¨çš„è¿è¡Œã€ç½‘ç»œç®¡ç†å’Œå­˜å‚¨è°ƒåº¦ï¼Œè®© K8s å®ç°å¼ºå¤§çš„å®¹å™¨ç¼–æ’èƒ½åŠ›ï¼**