## æœ‰çŠ¶æ€æœåŠ¡ä¸æ— çŠ¶æ€æœåŠ¡åŒºåˆ«

åœ¨ Kubernetesï¼ˆK8sï¼‰ä¸­ï¼Œ**æœ‰çŠ¶æ€æœåŠ¡ï¼ˆStateful Serviceï¼‰** å’Œ **æ— çŠ¶æ€æœåŠ¡ï¼ˆStateless Serviceï¼‰** å…·æœ‰ä¸åŒçš„ç‰¹æ€§å’Œä½¿ç”¨åœºæ™¯ã€‚ä¸‹é¢ä»å¤šä¸ªç»´åº¦å¯¹å®ƒä»¬è¿›è¡Œå¯¹æ¯”åˆ†æã€‚

------

### ä»€ä¹ˆæ˜¯æ— çŠ¶æ€æœåŠ¡ï¼ˆStateless Serviceï¼‰ï¼Ÿ

æ— çŠ¶æ€æœåŠ¡æŒ‡çš„æ˜¯**ä¸ä¾èµ–æœ¬åœ°å­˜å‚¨ï¼Œä¸ç»´æŠ¤å®¢æˆ·ç«¯çš„çŠ¶æ€**ï¼Œæ‰€æœ‰è¯·æ±‚éƒ½æ˜¯**ç‹¬ç«‹çš„**ï¼Œå¯ä»¥ç”±ä»»ä½•ä¸€ä¸ª Pod å¤„ç†ã€‚ä¾‹å¦‚ï¼š

- **Web åº”ç”¨ï¼ˆNginxã€Spring Bootã€Node.js API æœåŠ¡ï¼‰**
- **è´Ÿè½½å‡è¡¡å™¨**
- **HTTP/HTTPS ä»£ç†**

#### **ç‰¹ç‚¹**

| **ç‰¹æ€§**           | **æè¿°**                                            |
| ------------------ | --------------------------------------------------- |
| **è¯·æ±‚æ— å…³è”**     | æ¯ä¸ªè¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¾èµ–ä¹‹å‰çš„è¯·æ±‚æ•°æ®            |
| **æ— æœ¬åœ°å­˜å‚¨**     | æ•°æ®é€šå¸¸å­˜å‚¨åœ¨å¤–éƒ¨æ•°æ®åº“æˆ–ç¼“å­˜ä¸­ï¼ˆå¦‚ Redisã€MySQLï¼‰ |
| **æ°´å¹³æ‰©å±•æ–¹ä¾¿**   | ç”±äº Pod ä¹‹é—´æ²¡æœ‰çŠ¶æ€ï¼Œå¯ä»¥éšæ„æ‰©å±•å‰¯æœ¬æ•°           |
| **éƒ¨ç½²ç®€å•**       | é€‚ç”¨äº **Deployment**ï¼Œå¯ä»¥è½»æ¾è¿›è¡Œæ»šåŠ¨å‡çº§         |
| **å´©æºƒæ¢å¤å¿«**     | Pod å®•æœºåå¯ä»¥ç›´æ¥é‡å¯ï¼Œä¸å½±å“ä¸šåŠ¡                  |
| **é€‚åˆçŸ­ç”Ÿå‘½å‘¨æœŸ** | é€‚ç”¨äº HTTP APIã€è´Ÿè½½å‡è¡¡ç­‰                         |

####  å…¸å‹æ¶æ„

æ— çŠ¶æ€åº”ç”¨é€šå¸¸ä½¿ç”¨ **å¤–éƒ¨å­˜å‚¨** æ¥å­˜å‚¨æ•°æ®ï¼Œå¦‚ï¼š

- **æ•°æ®åº“**ï¼ˆMySQLã€PostgreSQLï¼‰
- **ç¼“å­˜**ï¼ˆRedisã€Memcachedï¼‰
- **å¯¹è±¡å­˜å‚¨**ï¼ˆS3ã€OSSï¼‰

#### **ç¤ºä¾‹**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: stateless-app
spec:
  replicas: 3  # ç›´æ¥æ‰©å±•å¤šä¸ªå‰¯æœ¬
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
        - name: app
          image: my-app:latest
          ports:
            - containerPort: 8080
```

> **ğŸ’¡ ç»“è®º**ï¼šé€‚ç”¨äºé«˜å¹¶å‘ã€æ˜“æ‰©å±•çš„ä¸šåŠ¡ï¼Œå¦‚ Web APIã€ç½‘å…³ã€CDN ä»£ç†ç­‰ã€‚

------

### **ä»€ä¹ˆæ˜¯æœ‰çŠ¶æ€æœåŠ¡ï¼ˆStateful Serviceï¼‰ï¼Ÿ**

æœ‰çŠ¶æ€æœåŠ¡éœ€è¦**ç»´æŠ¤æ•°æ®æŒä¹…æ€§ï¼Œå¹¶è¦æ±‚å›ºå®šçš„ Pod æ ‡è¯†**ï¼Œä¾‹å¦‚ï¼š

- **æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLã€MongoDBï¼‰**
- **æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaã€RabbitMQï¼‰**
- **åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆCephã€HDFSã€Elasticsearchï¼‰**

#### **ç‰¹ç‚¹**

| **ç‰¹æ€§**           | **æè¿°**                                                  |
| ------------------ | --------------------------------------------------------- |
| **è¯·æ±‚æœ‰çŠ¶æ€**     | éœ€è¦ç»´æŠ¤å®¢æˆ·ç«¯è¿æ¥çŠ¶æ€æˆ–ä¼šè¯ï¼ˆå¦‚ Kafka éœ€è¦è®°å½•æ¶ˆè´¹ä½ç‚¹ï¼‰ |
| **æœ¬åœ°å­˜å‚¨**       | éœ€è¦æŒ‚è½½æŒä¹…åŒ–å­˜å‚¨ï¼ˆPVCï¼‰æ¥ä¿å­˜æ•°æ®                       |
| **å›ºå®š Pod æ ‡è¯†**  | Pod ä¹‹é—´å­˜åœ¨èº«ä»½åŒºåˆ«ï¼ˆStatefulSet ç»´æŠ¤å›ºå®šåç§°ï¼‰          |
| **æ‰©å±•æœ‰åº**       | å‰¯æœ¬æ‰©å±•æ˜¯**æœ‰åºçš„**ï¼Œå¹¶ä¸”æ–° Pod å¯èƒ½ä¾èµ–æ—§ Pod æ•°æ®      |
| **é€‚åˆé•¿ç”Ÿå‘½å‘¨æœŸ** | é€‚ç”¨äºæ•°æ®åº“ã€åˆ†å¸ƒå¼å­˜å‚¨ç­‰ï¼ŒPod ä¸èƒ½éšæ„é”€æ¯              |

#### **å…¸å‹æ¶æ„**

æœ‰çŠ¶æ€åº”ç”¨é€šå¸¸ä¾èµ–**æŒä¹…åŒ–å­˜å‚¨**ï¼Œå¦‚ï¼š

- **Persistent Volumeï¼ˆPVï¼‰**
- **Persistent Volume Claimï¼ˆPVCï¼‰**
- **StatefulSet ä¿éšœ Pod çš„å”¯ä¸€æ€§**

####  **ç¤ºä¾‹**

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: stateful-app
spec:
  serviceName: "stateful-service"
  replicas: 3  # å‰¯æœ¬æ•°é‡
  selector:
    matchLabels:
      app: my-db
  template:
    metadata:
      labels:
        app: my-db
    spec:
      containers:
        - name: db
          image: mysql:5.7
          volumeMounts:
            - name: db-storage
              mountPath: /var/lib/mysql
  volumeClaimTemplates:
    - metadata:
        name: db-storage
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi
```

> **ğŸ’¡ ç»“è®º**ï¼šé€‚ç”¨äºæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ç­‰éœ€è¦å­˜å‚¨æ•°æ®çš„æœåŠ¡ã€‚

------

### **æ— çŠ¶æ€ vs æœ‰çŠ¶æ€ï¼šå¯¹æ¯”æ€»ç»“**

| **å¯¹æ¯”é¡¹**   | **æ— çŠ¶æ€æœåŠ¡ï¼ˆStatelessï¼‰** | **æœ‰çŠ¶æ€æœåŠ¡ï¼ˆStatefulï¼‰**                      |
| ------------ | --------------------------- | ----------------------------------------------- |
| **å­˜å‚¨ä¾èµ–** | å¤–éƒ¨å­˜å‚¨ï¼ˆæ•°æ®åº“ã€Redisï¼‰   | éœ€è¦æœ¬åœ°å­˜å‚¨ï¼ˆPVCï¼‰                             |
| **Pod å…³ç³»** | Pod ä¹‹é—´æ— å…³ç³»ï¼Œå¯éšæ„æ‰©å±•  | Pod ä¹‹é—´æœ‰èº«ä»½ï¼Œç¼–å·å›ºå®šï¼ˆå¦‚ `pod-0`ã€`pod-1`ï¼‰ |
| **æ‰©å±•æ–¹å¼** | ç›´æ¥æ‰©å±• Deployment å‰¯æœ¬æ•°  | éœ€è¦æœ‰åºæ‰©å±• StatefulSet                        |
| **é€‚åˆåœºæ™¯** | Web APIã€å¾®æœåŠ¡ã€ä»£ç†       | æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼å­˜å‚¨                    |
| **ç½‘ç»œæ ‡è¯†** | Pod IP åŠ¨æ€åˆ†é…             | Pod éœ€è¦å›ºå®šåŸŸåï¼ˆHeadless Serviceï¼‰            |
| **å‡çº§æ–¹å¼** | Deployment æ»šåŠ¨å‡çº§         | StatefulSet éœ€ç¡®ä¿æ•°æ®ä¸€è‡´æ€§                    |
| **æ¢å¤æ–¹å¼** | ç›´æ¥é‡å¯æ–° Pod              | Pod éœ€æ¢å¤ä¸Šæ¬¡æ•°æ®                              |

------

### **Deploymentä¸StatefulSetï¼Ÿ**

#### **é€‰æ‹© Deployment çš„æƒ…å†µ**

- ä½ çš„åº”ç”¨æ˜¯ **æ— çŠ¶æ€çš„**ï¼ˆå¦‚ Web æœåŠ¡å™¨ã€API ç½‘å…³ï¼‰ã€‚
- ä½ ä¸å…³å¿ƒ Pod åç§°ï¼ˆä»»ä½• Pod éƒ½èƒ½å¤„ç†è¯·æ±‚ï¼‰ã€‚
- ä½ å¸Œæœ›åº”ç”¨èƒ½å¤Ÿ **å¿«é€Ÿæ‰©å±•** å¹¶ **æ»šåŠ¨å‡çº§**ã€‚
- ä½ ä¸éœ€è¦æœ¬åœ°å­˜å‚¨ï¼Œæ•°æ®å¯ä»¥å­˜å‚¨åœ¨å¤–éƒ¨æ•°æ®åº“ã€‚

#### **é€‰æ‹© StatefulSet çš„æƒ…å†µ**

- ä½ çš„åº”ç”¨æ˜¯ **æœ‰çŠ¶æ€çš„**ï¼ˆå¦‚æ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼å­˜å‚¨ï¼‰ã€‚
- ä½ çš„åº”ç”¨éœ€è¦ **å›ºå®šçš„ Pod åç§°**ï¼ˆå¦‚ `mysql-0`ã€`mysql-1`ï¼‰ã€‚
- ä½ éœ€è¦ **æŒä¹…åŒ–å­˜å‚¨**ï¼ˆPod ä¸èƒ½éšæ„åˆ é™¤ï¼‰ã€‚
- ä½ çš„åº”ç”¨å¯¹ **æœ‰åºæ‰©å±•å’Œåˆ é™¤** æœ‰è¦æ±‚ï¼ˆæ–° Pod ä¾èµ–æ—§ Pod æ•°æ®ï¼‰ã€‚

## **Kubernetes Deployment è¯¦è§£**

####  1. Deployment æ˜¯ä»€ä¹ˆï¼Ÿ

`Deployment` æ˜¯ **Kubernetes ä¸­ç”¨äºç®¡ç†æ— çŠ¶æ€åº”ç”¨ï¼ˆStateless Applicationï¼‰çš„æ§åˆ¶å™¨**ï¼Œä¸»è¦ç”¨äº **åº”ç”¨çš„éƒ¨ç½²ã€æ›´æ–°ã€æ‰©å±•å’Œå›æ»š**ã€‚
 å®ƒé€šè¿‡ `ReplicaSet` ç®¡ç† `Pod`ï¼Œå¯ä»¥ä¿è¯æŒ‡å®šæ•°é‡çš„å‰¯æœ¬ï¼ˆreplicasï¼‰å§‹ç»ˆåœ¨è¿è¡Œï¼Œå¹¶æä¾› **æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updateï¼‰** å’Œ **å›æ»šï¼ˆRollbackï¼‰** æœºåˆ¶ã€‚

####  2. Deployment çš„ç‰¹ç‚¹

âœ… **å£°æ˜å¼ç®¡ç† Pod çš„å‰¯æœ¬æ•°**ï¼ˆ`replicas`ï¼‰
 âœ… **è‡ªåŠ¨åˆ›å»ºã€åˆ é™¤å’Œæ›¿æ¢ Pod**
 âœ… **æ”¯æŒæ»šåŠ¨æ›´æ–°ï¼Œæ— éœ€åœæœº**
 âœ… **æ”¯æŒå›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬**
 âœ… **å¯ç»“åˆ HPAï¼ˆæ°´å¹³è‡ªåŠ¨æ‰©å±•ï¼‰è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹**

------

#### **3. Deployment çš„æ ¸å¿ƒæ¦‚å¿µ**

##### **3.1 Deployment ç»“æ„**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: my-deployment
  labels:
    app: my-app
spec:
  replicas: 3  # æŒ‡å®šå‰¯æœ¬æ•°
  selector:
    matchLabels:
      app: my-app
  template:
    metadata:
      labels:
        app: my-app
    spec:
      containers:
      - name: nginx
        image: nginx:latest  # æŒ‡å®šå®¹å™¨é•œåƒ
        ports:
        - containerPort: 80
```

##### **3.2 è§£æ**

| **å­—æ®µ**                   | **ä½œç”¨**                  |
| -------------------------- | ------------------------- |
| `apiVersion: apps/v1`      | Deployment çš„ API ç‰ˆæœ¬    |
| `kind: Deployment`         | èµ„æºç±»å‹æ˜¯ Deployment     |
| `metadata.name`            | Deployment çš„åç§°         |
| `spec.replicas`            | éœ€è¦è¿è¡Œçš„ Pod å‰¯æœ¬æ•°é‡   |
| `selector.matchLabels`     | é€‰æ‹©ä¸ Pod æ ‡ç­¾åŒ¹é…çš„ Pod |
| `template.metadata.labels` | Pod çš„æ ‡ç­¾                |
| `template.spec.containers` | å®šä¹‰ Pod å†…éƒ¨è¿è¡Œçš„å®¹å™¨   |
| `image: nginx:latest`      | è¿è¡Œçš„é•œåƒ                |
| `containerPort: 80`        | è¿è¡Œçš„ç«¯å£                |

------

#### **4. Deployment å…³é”®åŠŸèƒ½**

##### **4.1 å‰¯æœ¬æ•°ç®¡ç†**

Deployment é€šè¿‡ `replicas` å­—æ®µ **æ§åˆ¶ Pod çš„æ•°é‡**ï¼Œå½“æŸä¸ª Pod å¤±è´¥æ—¶ï¼ŒK8s ä¼šè‡ªåŠ¨é‡æ–°åˆ›å»ºæ–°çš„ Pod ä»¥ä¿æŒå‰¯æœ¬æ•°ç¨³å®šã€‚

```sh
# ä¿®æ”¹å‰¯æœ¬æ•°é‡
kubectl scale deployment my-deployment --replicas=5

# æŸ¥çœ‹ Deployment è¿è¡ŒçŠ¶æ€
kubectl get deployment my-deployment
```

------

##### **4.2 æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updateï¼‰**

- **æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updateï¼‰** å…è®¸ **é€æ­¥æ›¿æ¢æ—§ç‰ˆæœ¬çš„ Pod**ï¼Œè€Œä¸ä¼šå¯¼è‡´æœåŠ¡ä¸­æ–­ã€‚
- é€šè¿‡ `kubectl set image` å‘½ä»¤æ›´æ–° Deploymentã€‚

```sh
# æ›´æ–° Deployment ä¸­çš„ Nginx ç‰ˆæœ¬
kubectl set image deployment my-deployment nginx=nginx:1.21.0
```

**K8s æ‰§è¡Œæµç¨‹**

1. **åˆ›å»ºæ–°çš„ Pod**ï¼ˆä½¿ç”¨æ–°çš„é•œåƒï¼‰
2. **æ–° Pod è¿è¡ŒæˆåŠŸåï¼Œåˆ é™¤æ—§ Pod**
3. **æ‰€æœ‰ Pod æ›´æ–°å®Œæˆ**

```sh
# æŸ¥çœ‹æ»šåŠ¨æ›´æ–°çŠ¶æ€
kubectl rollout status deployment my-deployment
```

**æŸ¥çœ‹ Deployment å†å²è®°å½•**

```sh
kubectl rollout history deployment my-deployment
```

------

##### **4.3 ç‰ˆæœ¬å›æ»šï¼ˆRollbackï¼‰**

å¦‚æœ Deployment æ›´æ–°å‡ºç°é—®é¢˜ï¼Œå¯ä»¥ **å›æ»šåˆ°ä¹‹å‰çš„ç‰ˆæœ¬**ã€‚

```sh
# å›æ»šåˆ°ä¸Šä¸€ä¸ªç‰ˆæœ¬
kubectl rollout undo deployment my-deployment

# å›æ»šåˆ°æŒ‡å®šç‰ˆæœ¬ï¼ˆæ¯”å¦‚ç‰ˆæœ¬ 3ï¼‰
kubectl rollout undo deployment my-deployment --to-revision=3
```

------

##### **4.4 HPA è‡ªåŠ¨æ‰©å±•**

Kubernetes å…è®¸ **åŸºäº CPU æˆ–å†…å­˜è´Ÿè½½è‡ªåŠ¨æ‰©ç¼©å®¹ Deployment**ï¼ˆHorizontal Pod Autoscaler, HPAï¼‰ã€‚

```sh
# è‡ªåŠ¨æ‰©å±• Deploymentï¼ŒCPU ä½¿ç”¨ç‡è¶…è¿‡ 50% æ—¶ï¼Œå‰¯æœ¬æ•°åœ¨ 2 åˆ° 10 ä¹‹é—´è‡ªåŠ¨è°ƒæ•´
kubectl autoscale deployment my-deployment --cpu-percent=50 --min=2 --max=10
```

**æŸ¥çœ‹ HPA çŠ¶æ€**

```sh
kubectl get hpa
```

------

##### **4.5 Deployment çš„æ›´æ–°ç­–ç•¥**

åœ¨ `spec.strategy` ä¸­ï¼ŒDeployment æä¾›ä¸¤ç§æ›´æ–°ç­–ç•¥ï¼š

1. **RollingUpdateï¼ˆé»˜è®¤ï¼‰**ï¼šé€æ­¥æ›¿æ¢æ—§ Podï¼ˆæ¨èï¼Œé›¶åœæœºï¼‰ã€‚
2. **Recreate**ï¼šå…ˆåˆ é™¤æ‰€æœ‰æ—§ Podï¼Œå†åˆ›å»ºæ–° Podï¼ˆä¼šçŸ­æš‚ä¸­æ–­ï¼‰ã€‚

```yaml
spec:
  strategy:
    type: RollingUpdate  # æ»šåŠ¨æ›´æ–°ç­–ç•¥
    rollingUpdate:
      maxSurge: 1  # å…è®¸æ¯”å‰¯æœ¬æ•°å¤šå‡ºçš„ Pod
      maxUnavailable: 1  # å…è®¸æœ€å¤§ä¸å¯ç”¨çš„ Pod æ•°
```

**ç¤ºä¾‹**

```sh
# è®¾ç½® Deployment çš„æ›´æ–°ç­–ç•¥ä¸º Recreate
kubectl patch deployment my-deployment -p '{"spec":{"strategy":{"type":"Recreate"}}}'
```

------

##### **4.6 åˆ é™¤ Deployment**

åˆ é™¤ Deployment ä¼š **åŒæ—¶åˆ é™¤æ‰€æœ‰ Pod**ã€‚

```sh
kubectl delete deployment my-deployment
```

å¦‚æœæƒ³ **ä¿ç•™ Pod ä½†åˆ é™¤ Deployment**ï¼š

```sh
kubectl delete deployment my-deployment --cascade=orphan
```

------

##### **5. Deployment vs å…¶ä»–æ§åˆ¶å™¨**

| **æ§åˆ¶å™¨**      | **ç”¨é€”**                                       |
| --------------- | ---------------------------------------------- |
| **Deployment**  | æ— çŠ¶æ€åº”ç”¨ï¼Œæ”¯æŒæ»šåŠ¨æ›´æ–°                       |
| **StatefulSet** | æœ‰çŠ¶æ€åº”ç”¨ï¼Œé€‚ç”¨äºæ•°æ®åº“ã€ç¼“å­˜                 |
| **DaemonSet**   | åœ¨æ¯ä¸ª Node ä¸Šè¿è¡Œä¸€ä¸ª Podï¼ˆå¦‚æ—¥å¿—æ”¶é›†ã€ç›‘æ§ï¼‰ |
| **Job**         | è¿è¡Œä¸€æ¬¡æ€§ä»»åŠ¡                                 |
| **CronJob**     | å®šæ—¶ä»»åŠ¡                                       |

------

##### **6. æ€»ç»“**

âœ… Deployment é€‚ç”¨äº **æ— çŠ¶æ€åº”ç”¨**ï¼ˆå¦‚ Web æœåŠ¡ï¼‰
 âœ… æ”¯æŒ **æ»šåŠ¨æ›´æ–°ï¼ˆRolling Updateï¼‰å’Œç‰ˆæœ¬å›æ»šï¼ˆRollbackï¼‰**
 âœ… å¯ç»“åˆ **HPA è¿›è¡Œè‡ªåŠ¨æ‰©ç¼©å®¹**
 âœ… æä¾› **å¤šç§æ›´æ–°ç­–ç•¥ï¼ˆRollingUpdate / Recreateï¼‰**
 âœ… é€šè¿‡ **`kubectl set image` å®ç°åº”ç”¨æ— åœæœºå‡çº§**

ğŸ’¡ **Deployment æ˜¯ Kubernetes æœ€å¸¸ç”¨çš„å·¥ä½œè´Ÿè½½ç®¡ç†æ–¹å¼**ï¼Œæ˜¯å¾®æœåŠ¡æ¶æ„å’Œ CI/CD çš„é‡è¦ç»„æˆéƒ¨åˆ†ã€‚

## **Kubernetes StatefulSet è¯¦è§£**

### **ä»€ä¹ˆæ˜¯ StatefulSetï¼Ÿ**

`StatefulSet` æ˜¯ Kubernetes æä¾›çš„ä¸€ç§ **ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨**ï¼ˆStateful Applicationsï¼‰çš„æ§åˆ¶å™¨ï¼Œä¸“é—¨ç”¨äº **éœ€è¦æŒä¹…åŒ–å­˜å‚¨ã€å›ºå®šç½‘ç»œæ ‡è¯†ã€ç¨³å®šéƒ¨ç½²é¡ºåº** çš„åº”ç”¨åœºæ™¯ï¼Œä¾‹å¦‚ï¼š

- **æ•°æ®åº“**ï¼ˆMySQLã€PostgreSQLã€MongoDBï¼‰
- **æ¶ˆæ¯é˜Ÿåˆ—**ï¼ˆKafkaã€RabbitMQï¼‰
- **åˆ†å¸ƒå¼å­˜å‚¨**ï¼ˆElasticsearchã€Cephã€HDFSï¼‰

**ğŸ“Œ StatefulSet ä¸»è¦è§£å†³çš„é—®é¢˜ï¼š**

- **Pod å…·æœ‰å›ºå®šçš„åç§°å’Œèº«ä»½**ï¼ˆPod ä¹‹é—´å­˜åœ¨ç¼–å·å…³ç³»ï¼Œå¦‚ `my-db-0`ã€`my-db-1`ï¼‰
- **Pod éœ€è¦æŒä¹…åŒ–å­˜å‚¨**ï¼ˆå³ Pod é‡å¯åæ•°æ®ä¸ä¼šä¸¢å¤±ï¼‰
- **Pod å¯åŠ¨ã€ç»ˆæ­¢é¡ºåºå›ºå®š**ï¼ˆé€‚ç”¨äºåˆ†å¸ƒå¼æ•°æ®åº“ã€ä¸»ä»å¤åˆ¶ç­‰ï¼‰
- **Pod éœ€è¦ç¨³å®šçš„ DNS åŸŸåè®¿é—®**ï¼ˆStatefulSet é€šè¿‡ Headless Service ä¿éšœ Pod å¯ä»¥è¢«æœ‰åºè®¿é—®ï¼‰

------

### **StatefulSet å…³é”®ç‰¹æ€§**

| **ç‰¹æ€§**             | **æè¿°**                                                     |
| -------------------- | ------------------------------------------------------------ |
| **å”¯ä¸€çš„ Pod åç§°**  | Pod åç§°å…·æœ‰ç¼–å·ï¼Œå¦‚ `mysql-0`ã€`mysql-1`                    |
| **å›ºå®šç½‘ç»œæ ‡è¯†**     | é€šè¿‡ Headless Service (`ClusterIP: None`) æä¾›ç¨³å®šçš„ DNS è®¿é—® |
| **æœ‰åºæ‰©å±•å’Œæ”¶ç¼©**   | Pod å¯åŠ¨å’Œåˆ é™¤æ—¶æŒ‰ç¼–å·é¡ºåºæ‰§è¡Œ                               |
| **æŒä¹…åŒ–å­˜å‚¨**       | æ¯ä¸ª Pod ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„ Persistent Volume Claimï¼ˆPVCï¼‰       |
| **Pod ä¸èƒ½éšæ„è°ƒåº¦** | ç”±äº Pod å…·æœ‰çŠ¶æ€ï¼Œå¯èƒ½ä¼šè¢«è°ƒåº¦å›åŸæ¥çš„ Node                 |

------

### **StatefulSet ç»“æ„**

ä¸€ä¸ª `StatefulSet` ä¸»è¦ç”±ä»¥ä¸‹ç»„ä»¶ç»„æˆï¼š

1. **StatefulSet èµ„æº**ï¼ˆå®šä¹‰ Pod ç®¡ç†è§„åˆ™ï¼‰
2. **Headless Service**ï¼ˆæä¾›ç¨³å®šçš„ç½‘ç»œè®¿é—®ï¼‰
3. **Persistent Volume Claimï¼ˆPVCï¼‰**ï¼ˆæŒä¹…åŒ–å­˜å‚¨ï¼‰

------

### **StatefulSet ç¤ºä¾‹**

##### **ä½¿ç”¨ MySQL éƒ¨ç½² StatefulSet**

###### **â‘  å®šä¹‰ Headless Service**

StatefulSet éœ€è¦ Headless Service ä½œä¸º DNS è§£ææœåŠ¡ï¼š

```yaml
apiVersion: v1
kind: Service
metadata:
  name: mysql
spec:
  clusterIP: None  # å…³é”®ï¼šæ—  ClusterIPï¼Œä¿è¯ç¨³å®š DNS
  selector:
    app: mysql
  ports:
    - port: 3306
      name: mysql
```

**ğŸ”¹ ä½œç”¨**ï¼š

- ```
  clusterIP: None
  ```

   è®© Kubernetes ä¸º StatefulSet çš„æ¯ä¸ª Pod åˆ†é…å›ºå®šçš„ DNSï¼Œå¦‚ï¼š

  - `mysql-0.mysql.default.svc.cluster.local`
  - `mysql-1.mysql.default.svc.cluster.local`

------

###### **â‘¡ å®šä¹‰ StatefulSet**

```yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: mysql
spec:
  serviceName: "mysql"  # ç»‘å®š Headless Service
  replicas: 3  # åˆ›å»º 3 ä¸ª MySQL Pod
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
        - name: mysql
          image: mysql:5.7
          ports:
            - containerPort: 3306
          env:
            - name: MYSQL_ROOT_PASSWORD
              value: "rootpassword"
          volumeMounts:
            - name: mysql-data
              mountPath: /var/lib/mysql  # MySQL æ•°æ®å­˜å‚¨ç›®å½•
  volumeClaimTemplates:
    - metadata:
        name: mysql-data
      spec:
        accessModes: ["ReadWriteOnce"]
        resources:
          requests:
            storage: 10Gi  # ç”³è¯· 10GB æŒä¹…åŒ–å­˜å‚¨
```

------

### **StatefulSet å…³é”®å­—æ®µè§£æ**

| **å­—æ®µ**                   | **ä½œç”¨**                                          |
| -------------------------- | ------------------------------------------------- |
| `serviceName`              | ç»‘å®š Headless Serviceï¼ˆå¿…é¡»æ˜¯ ClusterIP=Noneï¼‰    |
| `replicas`                 | å®šä¹‰å‰¯æœ¬æ•°é‡ï¼ˆé»˜è®¤ Pod åç§°ä¼šæŒ‰ `-0`ã€`-1` é€’å¢ï¼‰ |
| `volumeClaimTemplates`     | å®šä¹‰ PVCï¼Œæ¯ä¸ª Pod ç»‘å®šè‡ªå·±çš„å­˜å‚¨                 |
| `template.spec.containers` | å®šä¹‰ Pod è¿è¡Œçš„å®¹å™¨ï¼ˆMySQLï¼‰                      |

------

### **StatefulSet vs Deployment**

| **å¯¹æ¯”é¡¹**       | **StatefulSet**                | **Deployment**              |
| ---------------- | ------------------------------ | --------------------------- |
| **é€‚ç”¨åœºæ™¯**     | æœ‰çŠ¶æ€åº”ç”¨ï¼ˆæ•°æ®åº“ã€æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ | æ— çŠ¶æ€åº”ç”¨ï¼ˆWeb æœåŠ¡ã€APIï¼‰ |
| **Pod å‘½åæ–¹å¼** | `pod-0`ã€`pod-1`               | `pod-random-id`             |
| **Pod å…³ç³»**     | Pod ä¹‹é—´æœ‰é¡ºåºä¾èµ–             | Pod ä¹‹é—´æ— å…³ç³»              |
| **ç½‘ç»œæ ‡è¯†**     | å›ºå®š DNS è§£æ                  | éšæœº IP                     |
| **æ•°æ®å­˜å‚¨**     | ç»‘å®š PVCï¼ŒæŒä¹…åŒ–å­˜å‚¨           | Pod ç»ˆæ­¢åæ•°æ®ä¸¢å¤±          |
| **æ‰©ç¼©å®¹æ–¹å¼**   | æœ‰åºæ‰©å±•å’Œæ”¶ç¼©                 | å¹¶å‘æ‰©å±•                    |

------

### **StatefulSet ä¸»è¦ç®¡ç†è§„åˆ™**

- **æœ‰åºéƒ¨ç½²**ï¼šæŒ‰é¡ºåºä» `pod-0` åˆ° `pod-N` å¯åŠ¨ Podã€‚
- **æœ‰åºåˆ é™¤**ï¼šä» `pod-N` åˆ° `pod-0` æŒ‰é¡ºåºåˆ é™¤ã€‚
- **æœ‰åºæ»šåŠ¨æ›´æ–°**ï¼šPod ä¾æ¬¡æ›´æ–°ï¼Œè€Œä¸æ˜¯å…¨éƒ¨é‡å¯ã€‚
- **å›ºå®šå­˜å‚¨**ï¼šæ¯ä¸ª Pod ç»‘å®šä¸€ä¸ªå”¯ä¸€çš„ PVCï¼Œä¸ä¼šä¸å…¶ä»– Pod å…±äº«ã€‚

------

### **StatefulSet æ‰©ç¼©å®¹**

#### **æ‰©å±• StatefulSet**

å¦‚æœè¦å°†å‰¯æœ¬æ•°ä» `3` æ‰©å±•åˆ° `5`ï¼š

```sh
kubectl scale statefulset mysql --replicas=5
```

- Kubernetes **æŒ‰é¡ºåºåˆ›å»º** `mysql-3` å’Œ `mysql-4`ï¼Œä¸ä¼šå½±å“å·²æœ‰çš„ Podã€‚
- è¿™ä¸¤ä¸ªæ–° Pod ä¹Ÿä¼šç»‘å®šæ–°çš„ **PVC**ï¼ˆå­˜å‚¨ç‹¬ç«‹ï¼‰ã€‚

#### **ç¼©å®¹ StatefulSet**

å¦‚æœè¦å‡å°‘å‰¯æœ¬æ•°ï¼š

```sh
kubectl scale statefulset mysql --replicas=2
```

- ç¼©å®¹æ—¶ StatefulSet ä¸ä¼šåˆ é™¤ PVC

  ï¼Œéœ€è¦æ‰‹åŠ¨æ¸…ç†ï¼š

  ```sh
  kubectl delete pvc mysql-data-mysql-2
  ```

------

### **StatefulSet ä½¿ç”¨åœºæ™¯**

âœ… **é€‚åˆ**

- æ•°æ®åº“ï¼ˆMySQLã€PostgreSQLï¼‰
- æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆKafkaã€RabbitMQï¼‰
- åˆ†å¸ƒå¼å­˜å‚¨ï¼ˆElasticsearchã€HDFSï¼‰
- éœ€è¦å›ºå®šç½‘ç»œèº«ä»½çš„åº”ç”¨ï¼ˆZookeeperã€etcdï¼‰

âŒ **ä¸é€‚åˆ**

- æ— çŠ¶æ€ Web æœåŠ¡
- éœ€è¦åŠ¨æ€æ‰©å±•çš„å¾®æœåŠ¡
- çŸ­ç”Ÿå‘½å‘¨æœŸçš„ä»»åŠ¡

------

### **æ€»ç»“**

- **StatefulSet é€‚ç”¨äºæœ‰çŠ¶æ€åº”ç”¨**ï¼Œç¡®ä¿ Pod å…·æœ‰å›ºå®šåç§°ã€æŒä¹…åŒ–å­˜å‚¨ã€ç¨³å®šç½‘ç»œæ ‡è¯†ã€‚
- **æ¯ä¸ª Pod ç»‘å®šå”¯ä¸€ PVC**ï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œå³ä½¿ Pod è¢«é”€æ¯ã€‚
- **éœ€è¦ Headless Service æä¾›ç¨³å®šçš„ DNS**ï¼Œé¿å… IP å˜åŒ–å½±å“æœåŠ¡è®¿é—®ã€‚
- **æ‰©å±•å’Œç¼©å®¹æœ‰åºè¿›è¡Œ**ï¼Œä¿è¯åº”ç”¨çš„ä¸€è‡´æ€§ï¼Œé€‚ç”¨äºæ•°æ®åº“ã€åˆ†å¸ƒå¼å­˜å‚¨ç­‰åº”ç”¨ã€‚