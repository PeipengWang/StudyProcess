##  K8s æ ¸å¿ƒæ¶æ„

**å¾®æœåŠ¡k8séƒ¨ç½²æ¶æ„å›¾æ˜¯ä¸€ç§å°†å¾®æœåŠ¡åº”ç”¨éƒ¨ç½²åœ¨Kubernetesé›†ç¾¤ä¸­çš„æ¶æ„ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œæ¯ä¸ªå¾®æœåŠ¡éƒ½æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å®¹å™¨ï¼Œå®ƒä»¬é€šè¿‡Kubernetesçš„Serviceå’ŒIngressè¿›è¡Œé€šä¿¡ã€‚Kubernetes MasterèŠ‚ç‚¹è´Ÿè´£ç®¡ç†æ•´ä¸ªé›†ç¾¤ï¼ŒåŒ…æ‹¬è°ƒåº¦ã€æ‰©ç¼©å®¹ç­‰åŠŸèƒ½ã€‚NodeèŠ‚ç‚¹åˆ™è´Ÿè´£è¿è¡Œå®¹å™¨åŒ–çš„å¾®æœåŠ¡åº”ç”¨ã€‚æ­¤å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨Helmç­‰å·¥å…·æ¥ç®€åŒ–Kubernetesåº”ç”¨çš„éƒ¨ç½²å’Œç®¡ç†ã€‚æ€»ä¹‹ï¼Œå¾®æœåŠ¡k8séƒ¨ç½²æ¶æ„å›¾æä¾›äº†ä¸€ç§çµæ´»ã€å¯é çš„æ–¹å¼æ¥éƒ¨ç½²å’Œç®¡ç†å¾®æœåŠ¡åº”ç”¨ã€‚** 

**Master-Node æ¶æ„**ï¼ŒåŒ…æ‹¬ **æ§åˆ¶å¹³é¢** å’Œ **è®¡ç®—èŠ‚ç‚¹**ã€‚

![æ§åˆ¶å¹³é¢ï¼ˆkube-apiserverã€etcdã€kube-controller-managerã€kube-schedulerï¼‰å’Œå¤šä¸ªèŠ‚ç‚¹ã€‚æ¯ä¸ªèŠ‚ç‚¹è¿è¡Œ kubelet å’Œ kube-proxyã€‚](https://raw.githubusercontent.com/PeipengWang/picture/master/k8skubernetes-cluster-architecture.svg)



![img](https://raw.githubusercontent.com/PeipengWang/picture/master/k8sarchitecture.png)

### **ğŸ“ 2.1 Master ç»„ä»¶ï¼ˆæ§åˆ¶å¹³é¢ï¼‰**

| ç»„ä»¶                   | ä½œç”¨                                          |
| ---------------------- | --------------------------------------------- |
| **API Server**         | K8s **å…¥å£**ï¼Œå¤„ç† `kubectl` å’Œ REST API è¯·æ±‚ |
| **Scheduler**          | è´Ÿè´£ **Pod è°ƒåº¦**ï¼Œé€‰æ‹©è¿è¡ŒèŠ‚ç‚¹               |
| **Controller Manager** | è´Ÿè´£ **å‰¯æœ¬æ§åˆ¶ã€è‡ªåŠ¨æ‰©ç¼©ã€æ•…éšœæ¢å¤**         |
| **etcd**               | **åˆ†å¸ƒå¼å­˜å‚¨**ï¼Œä¿å­˜ K8s é…ç½®å’ŒçŠ¶æ€           |

------

### **2.2 Node ç»„ä»¶ï¼ˆè®¡ç®—èŠ‚ç‚¹ï¼‰**

| ç»„ä»¶                  | ä½œç”¨                                  |
| --------------------- | ------------------------------------- |
| **Kubelet**           | è´Ÿè´£ **ç®¡ç† Pod**ï¼Œä¸ API Server äº¤äº’ |
| **Kube Proxy**        | **ç½‘ç»œä»£ç†**ï¼Œç»´æŠ¤ Service è®¿é—®è§„åˆ™   |
| **Container Runtime** | è¿è¡Œå®¹å™¨ï¼ˆå¦‚ Docker, containerdï¼‰     |

```
+-----------------+
|  API Server    |  <--- å…¥å£
+-----------------+
|  Scheduler     |  <--- Pod è°ƒåº¦
+-----------------+
|  Controller    |  <--- ç›‘æ§/è‡ªåŠ¨ä¿®å¤
+-----------------+
|  etcd          |  <--- å­˜å‚¨æ•°æ®
+-----------------+

Master èŠ‚ç‚¹
------------------------------
Node èŠ‚ç‚¹ 1
+-----------------+
|  Kubelet       |  <--- è¿è¡Œ Pod
|  Kube Proxy    |  <--- è´Ÿè½½å‡è¡¡
|  å®¹å™¨ Runtime  |
+-----------------+

Node èŠ‚ç‚¹ 2
+-----------------+
|  Kubelet       |
|  Kube Proxy    |
|  å®¹å™¨ Runtime  |
+-----------------+

```

## **3. K8s èµ„æºå¯¹è±¡**

K8s é€šè¿‡ **å£°æ˜å¼ API** æ¥ç®¡ç†èµ„æºã€‚

### **ğŸ“ 3.1 è®¡ç®—**

| èµ„æº          | ä½œç”¨                           |
| ------------- | ------------------------------ |
| **Pod**       | **æœ€å°è®¡ç®—å•å…ƒ**ï¼Œå°è£…å¤šä¸ªå®¹å™¨ |
| **Node**      | è¿è¡Œ Pod çš„ç‰©ç†/è™šæ‹Ÿæœº         |
| **Namespace** | **é€»è¾‘éš”ç¦»**ï¼Œæ”¯æŒå¤šç§Ÿæˆ·       |

------

### **ğŸ“ 3.2 è´Ÿè½½ï¼ˆä»»åŠ¡åº”ç”¨ï¼‰ç®¡ç†**

| èµ„æº            | ä½œç”¨                             |
| --------------- | -------------------------------- |
| **Deployment**  | **ç®¡ç†æ— çŠ¶æ€åº”ç”¨**ï¼Œæ”¯æŒæ»šåŠ¨å‡çº§ |
| **StatefulSet** | **ç®¡ç†æœ‰çŠ¶æ€åº”ç”¨**ï¼ˆå¦‚æ•°æ®åº“ï¼‰   |
| **DaemonSet**   | **æ‰€æœ‰èŠ‚ç‚¹** ä¸Šéƒ½è¿è¡Œç›¸åŒçš„ Pod  |
| **Job**         | **ä¸€æ¬¡æ€§ä»»åŠ¡**ï¼ˆæˆåŠŸååœæ­¢ï¼‰     |
| **CronJob**     | **å®šæ—¶ä»»åŠ¡**ï¼ˆç±»ä¼¼ crontabï¼‰     |

------

### **ğŸ“ 3.3 æœåŠ¡å‘ç°ä¸è®¿é—®**

| èµ„æº             | ä½œç”¨                                  |
| ---------------- | ------------------------------------- |
| **Service**      | æä¾› **ç¨³å®šè®¿é—®** å’Œ **è´Ÿè½½å‡è¡¡**     |
| **ClusterIP**    | **ä»…é›†ç¾¤å†…éƒ¨è®¿é—®**                    |
| **NodePort**     | é€šè¿‡ `NodeIP:Port` è®¿é—®               |
| **LoadBalancer** | **å¤–éƒ¨è´Ÿè½½å‡è¡¡**ï¼ˆäº‘ç¯å¢ƒé€‚ç”¨ï¼‰        |
| **Ingress**      | **HTTP/HTTPS è®¿é—®æ§åˆ¶**ï¼ˆç±»ä¼¼ Nginxï¼‰ |

------

### **ğŸ“ 3.4 é…ç½®ä¸å­˜å‚¨**

| èµ„æº                            | ä½œç”¨                                      |
| ------------------------------- | ----------------------------------------- |
| **ConfigMap**                   | **å­˜å‚¨é…ç½®ä¿¡æ¯**ï¼ˆå¦‚ `.properties` æ–‡ä»¶ï¼‰ |
| **Secret**                      | **å­˜å‚¨æ•æ„Ÿæ•°æ®**ï¼ˆå¦‚å¯†ç ã€API Keyï¼‰       |
| **PersistentVolume (PV)**       | **ç®¡ç†å‘˜åˆ›å»º** çš„æŒä¹…åŒ–å­˜å‚¨               |
| **PersistentVolumeClaim (PVC)** | **ç”¨æˆ·ç”³è¯·** æŒä¹…åŒ–å­˜å‚¨                   |

------

### **ğŸ“ 3.5 å®‰å…¨**

| èµ„æº                         | ä½œç”¨                                  |
| ---------------------------- | ------------------------------------- |
| **RBACï¼ˆè§’è‰²è®¿é—®æ§åˆ¶ï¼‰**     | **ç”¨æˆ·æƒé™ç®¡ç†**                      |
| **NetworkPolicy**            | **é™åˆ¶ Pod ä¹‹é—´é€šä¿¡**                 |
| **PodSecurityPolicyï¼ˆPSPï¼‰** | **æ§åˆ¶ Pod å®‰å…¨ç­–ç•¥**ï¼ˆå¦‚ root æƒé™ï¼‰ |



## **ğŸ“Œ 4. K8s è¿è¡Œæœºåˆ¶**

### **ğŸš€ 4.1 Pod è°ƒåº¦æµç¨‹**

1ï¸âƒ£ **ç”¨æˆ·æäº¤ Pod ç”³è¯·**ï¼ˆ`kubectl apply -f pod.yaml`ï¼‰
2ï¸âƒ£ **API Server** å¤„ç†è¯·æ±‚ï¼Œå­˜å…¥ `etcd`
3ï¸âƒ£ **Scheduler** é€‰æ‹©åˆé€‚çš„ Node è¿è¡Œ Pod
4ï¸âƒ£ **Kubelet** è´Ÿè´£åœ¨ Node ä¸Šæ‹‰å–é•œåƒå¹¶è¿è¡Œ Pod
5ï¸âƒ£ **Kube Proxy** è´Ÿè´£ç½‘ç»œä»£ç†å’Œè´Ÿè½½å‡è¡¡



### **ğŸš€ 4.2 æ»šåŠ¨å‡çº§**

- **æ»šåŠ¨æ›´æ–°ï¼ˆRollingUpdateï¼‰**ï¼šé€æ­¥æ›¿æ¢ Pod
- **å›æ»šï¼ˆRollbackï¼‰**ï¼šæ¢å¤åˆ°ä¹‹å‰ç‰ˆæœ¬
- **è“ç»¿éƒ¨ç½²ï¼ˆBlue-Greenï¼‰**ï¼šæ–°æ—§ç‰ˆæœ¬åŒæ—¶è¿è¡Œï¼Œåˆ‡æ¢æµé‡

## **ğŸ“Œ 5. K8s é«˜å¯ç”¨æ¶æ„**

### **ğŸ”¥ 5.1 Master é«˜å¯ç”¨**

- **å¤š Master**ï¼šé€šè¿‡ `HAProxy + Keepalived` è´Ÿè½½å‡è¡¡
- **etcd é«˜å¯ç”¨**ï¼š3-5 èŠ‚ç‚¹åˆ†å¸ƒå¼å­˜å‚¨

### **ğŸ”¥ 5.2 Node é«˜å¯ç”¨**

- **å¤šä¸ª Node è¿è¡Œ Pod**
- **è‡ªåŠ¨æ‰©å±•ï¼ˆHPAï¼‰**ï¼šæ ¹æ®è´Ÿè½½è‡ªåŠ¨è°ƒæ•´ Pod æ•°é‡